# SecureWatch Pro - Backend Setup

This document provides instructions for setting up and using the SecureSight. SecureSight is a CCTV monitoring software where you can connect upto 3 CCTV feeds â€” computer vision models help detect certain activity on the feeds (e.g. unauthorised access, gun threats, etc). backend.

## Prerequisites

1. Node.js (v23 or later)
2. npm or yarn
3. Supabase account

## Setup Instructions

### 1. Set up Supabase

1. Create a new project in Supabase (https://app.supabase.com/)
2. Go to Project Settings > API to find your project URL and anon/public key
3. Create a `.env.local` file in the root directory with:
   ```
   NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
   NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key
   ```

### 2. Set up Database

1. In your Supabase dashboard, go to the SQL editor
2. Run the following SQL to create the required tables:

```sql
-- Create Cameras Table
CREATE TABLE public.cameras (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name TEXT NOT NULL,
  location TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::TEXT, NOW()) NOT NULL
);

-- Create Incident Tracking Table
CREATE TABLE public.incidents (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  camera_id BIGINT REFERENCES public.cameras(id) ON DELETE CASCADE,
  type TEXT NOT NULL,
  t_start TIMESTAMP WITH TIME ZONE NOT NULL,
  t_end TIMESTAMP WITH TIME ZONE,
  thumbnail_url TEXT,
  resolved BOOLEAN DEFAULT FALSE,
  description TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::TEXT, NOW()) NOT NULL
);

-- Enable Row Level Security
ALTER TABLE public.cameras ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.incidents ENABLE ROW LEVEL SECURITY;

-- Set up RLS policies (adjust as needed for your security requirements)
CREATE POLICY "Enable read access for all users" ON public.cameras
  FOR SELECT USING (true);

CREATE POLICY "Enable read access for all users" ON public.incidents
  FOR SELECT USING (true);

CREATE POLICY "Enable update for all users" ON public.incidents
  FOR UPDATE USING (true) WITH CHECK (true);
```

### 3. Install Dependencies

```bash
npm install
```

### 4. Seed the Database

Run the seed script to populate the database with sample data:

```bash
node scripts/seed.js
```

## API Endpoints

## API Testing Guide

### 1. Get All Incidents

Fetch all incidents, optionally filtered by resolution status.

**Endpoint:**
```
GET /api/incidents
```

**Query Parameters:**
- `resolved` (boolean, optional): Filter by resolution status

**Test in Browser:**
1. Open your browser
2. Visit: `http://localhost:4028/api/incidents`
3. Or filter unresolved incidents: `http://localhost:4028/api/incidents?resolved=false`

**Example Response:**
```json
[
  {
    "id": 1,
    "camera_id": 1,
    "type": "Unauthorised Access",
    "t_start": "2025-07-23T08:00:00.000Z",
    "t_end": "2025-07-23T08:05:00.000Z",
    "thumbnail_url": "https://picsum.photos/seed/123/300/200",
    "resolved": false,
    "description": "Sample security incident detected",
    "camera": {
      "id": 1,
      "name": "Main Entrance",
      "location": "Ground Floor"
    }
  }
]
```

### 2. Toggle Incident Resolution

Toggle the resolution status of an incident.

**Endpoint:**
```
PATCH /api/incidents/:id/resolve
```

**How to Test:**
1. First, get an incident ID from `/api/incidents`
2. Open browser's Developer Tools (F12)
3. Go to the Console tab
4. Paste and run this code (replace `20` with your incident ID):

```javascript
fetch('http://localhost:4028/api/incidents/20/resolve', {
  method: 'PATCH',
  headers: { 'Content-Type': 'application/json' }
})
  .then(response => response.json())
  .then(data => console.log('Success:', data))
  .catch(error => console.error('Error:', error));
```

**Expected Response:**
```json
{
  "id": 20,
  "resolved": true,
  "type": "Perimeter Breach",
  "t_start": "2025-07-23T07:07:45.522Z",
  "t_end": "2025-07-23T07:21:45.522Z",
  "camera": {
    "id": 10,
    "name": "Vault",
    "location": "Basement Level"
  }
}
```

## Development

1. Start the development server:
   ```bash
   npm run dev
   ```

2. The API will be available at `http://localhost:3000/api/...`

## Deployment

When deploying to production, make sure to:
1. Update environment variables with production Supabase credentials
2. Adjust RLS policies in Supabase for production security requirements
3. Consider implementing proper authentication for write operations
